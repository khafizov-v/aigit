# Commit Details: 8504db22

**Repository:** [qf-solochain](https://github.com/QuantumFusion-network/qf-solochain)
**Author:** Andrei Orlov (andor0)
**Date:** 2025-06-04 08:24:58+00:00
**Branch(es):** andor0/issue-371-2
**Commit Link:** [View on GitHub](https://github.com/QuantumFusion-network/qf-solochain/commit/8504db22662df21a35773ca6f147594951a5e13b)

## Commit Message
```
Use StorageValue instead of CodeStorageValue
```

## Statistics
- **Files changed:** 2
- **Lines added:** 15
- **Lines deleted:** 14
- **Total changes:** 29

## File Changes

### ✏️ pallets/qf-polkavm/src/lib.rs (modified)
**Changes:** +10 -9

```diff
@@ -83,7 +83,6 @@ pub mod pallet {
 	type CodeHash<T> = <T as frame_system::Config>::Hash;
 	type CodeVec<T> = BoundedVec<u8, <T as Config>::MaxCodeLen>;
 	pub(super) type CodeVersion = u64;
-	pub(super) type CodeStorageValue<T> = StorageValue<T>;
 	pub(super) type StorageKey<T> = BoundedVec<u8, <T as Config>::MaxStorageKeySize>;
 	pub(super) type CodeStorageKey<T> =
 		(<T as frame_system::Config>::AccountId, StorageKey<T>);
@@ -95,7 +94,7 @@ pub mod pallet {
 	}
 
 	pub(super) type MutatingStorageOperation<T> =
-		(MutatingStorageOperationType, CodeStorageKey<T>, Option<CodeStorageValue<T>>);
+		(MutatingStorageOperationType, CodeStorageKey<T>, Option<StorageValue<T>>);
 
 	#[derive(Debug, Encode, Decode, MaxEncodedLen, TypeInfo, PartialEq)]
 	#[scale_info(skip_type_params(T))]
@@ -113,7 +112,8 @@ pub mod pallet {
 		pub gas_after: i64,
 	}
 
-	#[derive(Debug, Encode, Decode, MaxEncodedLen, TypeInfo, PartialEq)]
+	#[derive(Debug, Clone, Encode, Decode, MaxEncodedLen, TypeInfo, PartialEq)]
+	#[scale_info(skip_type_params(T))]
 	pub(super) struct StorageValue<T: Config> {
 		pub data: BoundedVec<u8, <T as Config>::StorageSize>,
 		pub owner: T::AccountId, 
@@ -191,7 +191,7 @@ pub mod pallet {
 
 	#[pallet::storage]
 	pub(super) type CodeStorage<T: Config> =
-		StorageMap<_, Blake2_128Concat, CodeStorageKey<T>, CodeStorageValue<T>>;
+		StorageMap<_, Blake2_128Concat, CodeStorageKey<T>, StorageValue<T>>;
 
 	/// Events that functions in this pallet can emit.
 	///
@@ -419,16 +419,17 @@ pub mod pallet {
 				|contract_address: T::AccountId,
 				 key: StorageKey<T>|
 				 -> Option<Vec<u8>> {
-					CodeStorage::<T>::get((contract_address, key)).map(|d| d.to_vec())
+					CodeStorage::<T>::get((contract_address, key)).map(|d| d.data.to_vec())
 				},
 				|contract_address: T::AccountId,
+				caller: T::AccountId,
 				 key: StorageKey<T>,
 				 max_storage_size: usize,
 				 mut data: Vec<u8>|
 				 -> u64 {
 					let mut buffer = BoundedVec::with_bounded_capacity(max_storage_size);
 					if let Ok(_) = buffer.try_append(&mut data) {
-						CodeStorage::<T>::insert((contract_address, key), buffer);
+						CodeStorage::<T>::insert((contract_address, key), StorageValue { data: buffer, owner: caller });
 						0
 					} else {
 						1
@@ -611,7 +612,7 @@ pub mod pallet {
 								caller.user_data.addresses[0].clone(),
 								storage_key.clone(),
 							)) {
-								Some(Some(r)) => Some(r.to_vec()),
+								Some(Some(r)) => Some(r.data.to_vec()),
 								Some(None) => None,
 								None => (caller.user_data.get)(
 									caller.user_data.addresses[0].clone(),
@@ -667,14 +668,14 @@ pub mod pallet {
 										caller.user_data.addresses[0].clone(),
 										storage_key.clone(),
 									),
-									Some(data.clone()),
+									Some(StorageValue { data: data.clone(), owner: caller.user_data.addresses[1].clone() }),
 								));
 								caller.user_data.raw_storage.insert(
 									(
 										caller.user_data.addresses[0].clone(),
 										storage_key,
 									),
-									Some(data),
+									Some(StorageValue{ data, owner: caller.user_data.addresses[1].clone() }),
 								);
 
 								return 0;
```

### ✏️ pallets/qf-polkavm/src/polkavm/linker.rs (modified)
**Changes:** +5 -5

```diff
@@ -1,7 +1,7 @@
 extern crate alloc;
 
 use crate::{
-	BalanceOf, CodeStorageKey, CodeStorageValue, CodeVersion, Config as PalletConfig,
+	BalanceOf, CodeStorageKey, StorageValue, CodeVersion, Config as PalletConfig,
 	MutatingStorageOperation, StorageKey,
 	polkavm::{
 		Error, InterruptKind, Module, ProgramCounter, RawInstance, Reg, api::RegValue, error::bail,
@@ -598,7 +598,7 @@ pub struct State<T: PalletConfig> {
 	pub log_message: Vec<u8>,
 	pub user_data: Vec<u8>,
 	pub mutating_operations: Vec<MutatingStorageOperation<T>>,
-	pub raw_storage: BTreeMap<CodeStorageKey<T>, Option<CodeStorageValue<T>>>,
+	pub raw_storage: BTreeMap<CodeStorageKey<T>, Option<StorageValue<T>>>,
 	pub code_version: CodeVersion,
 	pub max_storage_size: usize,
 	pub max_storage_key_size: u32,
@@ -610,7 +610,7 @@ pub struct State<T: PalletConfig> {
 	pub account_id: fn() -> u64,
 	pub caller: fn() -> u64,
 	pub get: fn(T::AccountId, StorageKey<T>) -> Option<Vec<u8>>,
-	pub insert: fn(T::AccountId, StorageKey<T>, usize, Vec<u8>) -> u64,
+	pub insert: fn(T::AccountId, T::AccountId, StorageKey<T>, usize, Vec<u8>) -> u64,
 	pub delete: fn(T::AccountId, StorageKey<T>) -> u64,
 }
 
@@ -621,7 +621,7 @@ impl<T: PalletConfig> State<T> {
 		log_message: Vec<u8>,
 		user_data: Vec<u8>,
 		mutating_operations: Vec<MutatingStorageOperation<T>>,
-		raw_storage: BTreeMap<CodeStorageKey<T>, Option<CodeStorageValue<T>>>,
+		raw_storage: BTreeMap<CodeStorageKey<T>, Option<StorageValue<T>>>,
 		code_version: CodeVersion,
 		max_storage_size: usize,
 		max_storage_key_size: u32,
@@ -633,7 +633,7 @@ impl<T: PalletConfig> State<T> {
 		account_id: fn() -> u64,
 		caller: fn() -> u64,
 		get: fn(T::AccountId, StorageKey<T>) -> Option<Vec<u8>>,
-		insert: fn(T::AccountId, StorageKey<T>, usize, Vec<u8>) -> u64,
+		insert: fn(T::AccountId, T::AccountId, StorageKey<T>, usize, Vec<u8>) -> u64,
 		delete: fn(T::AccountId, StorageKey<T>) -> u64,
 	) -> Self {
 		Self {
```
